name: Build and Push Changed Docker Images

on:
  push:
    branches:
      - master

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: '**/Dockerfile'

      - name: Generate matrix of changed images
        id: changes
        run: |
          IMAGES=()
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            dir_path=$(dirname "$file")
            name=$(cut -d'/' -f1 <<< "$dir_path")
            version=$(cut -d'/' -f2 <<< "$dir_path")

            image_json=$(printf '{"org": "%s", "name": "%s", "version": "%s"}' "$org" "$name" "$version")
            IMAGES+=("$image_json")
          done

          IMAGE_LIST=$(IFS=,; echo "${IMAGES[*]}")

          printf 'matrix={"include":[%s]}\n' "$IMAGE_LIST" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.matrix != '{}' }}
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.name }}/${{ matrix.version }}
          file: ${{ matrix.name }}/${{ matrix.version }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}:${{ matrix.version }}
