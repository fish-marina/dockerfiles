name: Build and Push Changed Docker Images

on:
  push:
    branches:
      - master

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: '**/Dockerfile'

      - name: Generate matrix of changed images
        id: changes
        run: |
          IMAGES=()
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            dir_path=$(dirname "$file")
            name=$(cut -d'/' -f1 <<< "$dir_path")
            version=$(cut -d'/' -f2 <<< "$dir_path")

            image_json=$(printf '{"name": "%s", "version": "%s"}' "$name" "$version")
            IMAGES+=("$image_json")
          done

          IMAGE_LIST=$(IFS=,; echo "${IMAGES[*]}")

          printf 'matrix={"include":[%s]}\n' "$IMAGE_LIST" >> "$GITHUB_OUTPUT"

  build-amd64:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.matrix != '{}' }}
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build AMD64 image
        uses: docker/build-push-action@v6
        id: build-push
        with:
          context: ${{ matrix.name }}/${{ matrix.version }}
          file: ${{ matrix.name }}/${{ matrix.version }}/Dockerfile
          platforms: linux/amd64
          outputs: push-by-digest=true,type=image,push=true

      - uses: beacon-biosignals/matrix-output@v1
        id: matrix-output
        with:
          yaml: |
            name: ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}:${{ matrix.version }}
            digest_name: ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}@${{ steps.build-push.outputs.digest }}

  build-arm64:
    needs: detect-changes
    runs-on: ubuntu-24.04-arm
    if: ${{ needs.detect-changes.outputs.matrix != '{}' }}
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 image
        uses: docker/build-push-action@v6
        id: build-push
        with:
          context: ${{ matrix.name }}/${{ matrix.version }}
          file: ${{ matrix.name }}/${{ matrix.version }}/Dockerfile
          platforms: linux/arm64
          outputs: push-by-digest=true,type=image,push=true

      - uses: beacon-biosignals/matrix-output@v1
        id: matrix-output
        with:
          yaml: |
            name: ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}:${{ matrix.version }}
            digest_name: ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}@${{ steps.build-push.outputs.digest }}

  stitch-multiarch:
    needs: [detect-changes, build-amd64, build-arm64]
    runs-on: ubuntu-24.04
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Push multi-arch image
        run: |
          docker buildx imagetools create \
            --tag ${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}:${{ matrix.version }} \
            $(echo '${{ needs.build-arm64.outputs.json }}' | jq '.[] | select(.name == "${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}") | .digest_name' -r) \
            $(echo '${{ needs.build-arm64.outputs.json }}' | jq '.[] | select(.name == "${{ vars.DOCKERHUB_ORG }}/${{ matrix.name }}") | .digest_name' -r)
